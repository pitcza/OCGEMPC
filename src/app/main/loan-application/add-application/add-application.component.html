<div class="main-overlay">
  <div class="modal-container">
    <!-- Header Section -->
    <div class="modal-head">
      <div class="modal-title">
        <h1>Loan Application Form</h1>
      </div>
      <button class="exit-button" (click)="closeModal()">&times;</button>
    </div>

    <!-- Form Body -->
    <div class="modal-body">
      <form [formGroup]="loanForm" (ngSubmit)="onSubmit()">
        <div class="section-group">
          <!-- Maker Selection -->
          <div class="input-row">
            <div class="input-group">
              <div class="section-header">
                <h3>Select Maker</h3>
                <button
                  type="button"
                  class="add-button"
                  (click)="openNewMakerDialog()"
                >
                  <span>+ Add New Maker</span>
                </button>
              </div>

              <!-- Selected Maker Preview -->
              <div class="selected-preview" *ngIf="selectedMaker">
                <div class="preview-header">
                  <h4>Selected Maker</h4>
                  <button
                    type="button"
                    class="clear-button"
                    (click)="clearMakerSelection()"
                  >
                    Change Maker
                  </button>
                </div>
                <div class="preview-content">
                  <p>
                    <strong>Name:</strong> {{ selectedMaker.first_name }}
                    {{ selectedMaker.middle_name }}
                    {{ selectedMaker.last_name }} {{ selectedMaker.ext_name }}
                  </p>
                  <p><strong>Address:</strong> {{ selectedMaker.address }}</p>
                  <p><strong>Contact:</strong> {{ selectedMaker.phone_num }}</p>
                  <p>
                    <strong>Position:</strong> {{ selectedMaker.position }} ({{
                      selectedMaker.dept
                    }})
                  </p>
                </div>
              </div>

              <!-- Maker Selection Dropdown -->
              <div class="select-container" *ngIf="!selectedMaker">
                <div class="search-wrapper">
                  <input
                    type="text"
                    placeholder="Search makers..."
                    class="search-input"
                    [(ngModel)]="makerSearchTerm"
                    (input)="filterMakers()"
                    name="makerSearch"
                    [ngModelOptions]="{ standalone: true }"
                  />
                  <span class="search-icon">üîç</span>
                </div>
                <div class="select-options" #modalBody>
                  <div *ngIf="filteredMakers.length === 0" class="no-results">
                    No maker found.
                  </div>
                  <div
                    *ngFor="let maker of filteredMakers"
                    class="select-option"
                    (click)="onMakerSelect(maker)"
                  >
                    <div class="option-content">
                      <span class="option-name"
                        >{{ maker.first_name }} {{ maker.last_name }}</span
                      >
                      <span class="option-details"
                        >{{ maker.position }} ‚Ä¢ {{ maker.dept }}</span
                      >
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Comaker Selection -->
          <div class="input-row">
            <div class="input-group">
              <div class="section-header">
                <h3>Select Comaker</h3>
              </div>

              <!-- Selected Comaker Preview -->
              <div class="selected-preview" *ngIf="selectedComaker">
                <div class="preview-header">
                  <h4>Selected Comaker</h4>
                  <button
                    type="button"
                    class="clear-button"
                    (click)="clearComakerSelection()"
                  >
                    Change Comaker
                  </button>
                </div>
                <div class="preview-content">
                  <p>
                    <strong>Name:</strong> {{ selectedComaker.first_name }}
                    {{ selectedComaker.middle_name }}
                    {{ selectedComaker.last_name }}
                    {{ selectedComaker.ext_name }}
                  </p>
                  <p><strong>Address:</strong> {{ selectedComaker.address }}</p>
                  <p><strong>Contact:</strong> {{ selectedComaker.phone_num }}</p>
                  <p>
                    <strong>Position:</strong> {{ selectedComaker.position }} ({{
                      selectedComaker.dept
                    }})
                  </p>
                </div>
              </div>

              <!-- Comaker Selection Dropdown -->
              <div class="select-container" *ngIf="!selectedComaker">
                <div class="search-wrapper">
                  <input
                    type="text"
                    placeholder="Search comakers..."
                    class="search-input"
                    [(ngModel)]="comakerSearchTerm"
                    (input)="filterComakers()"
                    name="comakerSearch"
                    [ngModelOptions]="{ standalone: true }"
                  />
                  <span class="search-icon">üîç</span>
                </div>
                <div class="select-options" #modalBody>
                  <div
                    *ngIf="filteredComakers.length === 0"
                    class="no-results"
                  >
                    No comaker found.
                  </div>
                  <div
                    *ngFor="let comaker of filteredComakers"
                    class="select-option"
                    (click)="onComakerSelect(comaker)"
                  >
                    <div class="option-content">
                      <span class="option-name"
                        >{{ comaker.first_name }} {{ comaker.last_name }}</span
                      >
                      <span class="option-details"
                        >{{ comaker.position }} ‚Ä¢ {{ comaker.dept }}</span
                      >
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Loan Details -->
          <div class="section-group">
            <h2>Loan Information</h2>
            <div class="input-row">
              <div class="input-group">
                <label class="label">Type of Loan</label>
                <select class="text-field" formControlName="loan_type">
                  <option value="" disabled>Select Type</option>
                  <option value="Regular">Regular</option>
                  <option value="Secured">Secured</option>
                  <option value="Educational">Educational</option>
                  <option value="Livelihood">Livelihood</option>
                  <option value="Medical">Medical</option>
                  <option value="Emergency">Emergency</option>
                  <option value="Housing">Housing</option>
                </select>
              </div>
              <div class="input-group">
                <label class="label">Amount of loan applied</label>
                <input
                  type="number"
                  class="text-field"
                  formControlName="applied_amount"
                  placeholder="ex. 60000"
                />
              </div>
            </div>

            <div class="input-row">
              <div class="input-group">
                <label class="label">Loan Term (months)</label>
                <input
                  type="number"
                  class="text-field"
                  formControlName="loan_term"
                  placeholder="ex. 24"
                />
              </div>
              <div class="input-group">
                <label class="label">Purpose of Loan</label>
                <input
                  type="text"
                  class="text-field"
                  formControlName="loan_purpose"
                  placeholder="ex. Education expenses"
                />
              </div>
              <div class="input-group">
                <label class="label">Repayment Frequency</label>
                <select class="text-field" formControlName="repayment_freq">
                  <option value="Monthly">Monthly</option>
                  <option value="Bi-Monthly">Bi-Monthly</option>
                  <option value="Quarterly">Quarterly</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Required Documents -->
          <div class="section-group">
            <h2>Required Documents</h2>
            <div class="documents-grid">
              <label class="document-checkbox">
                <input type="checkbox" formControlName="payslip" />
                <span class="checkmark"></span>
                Payslip
              </label>
              <label class="document-checkbox">
                <input type="checkbox" formControlName="valid_id" />
                <span class="checkmark"></span>
                Valid ID
              </label>
              <label class="document-checkbox">
                <input type="checkbox" formControlName="company_id" />
                <span class="checkmark"></span>
                Company ID
              </label>
              <label class="document-checkbox">
                <input type="checkbox" formControlName="proof_of_billing" />
                <span class="checkmark"></span>
                Proof of Billing
              </label>
              <label class="document-checkbox">
                <input type="checkbox" formControlName="employment_details" />
                <span class="checkmark"></span>
                Employment Details
              </label>
              <label class="document-checkbox">
                <input type="checkbox" formControlName="barangay_clearance" />
                <span class="checkmark"></span>
                Barangay Clearance
              </label>
            </div>
          </div>

          <!-- Buttons -->
          <div class="buttons">
            <div class="left">
              <button type="button" class="cancel-btn" (click)="closeModal()">
                Cancel
              </button>
            </div>
            <div class="right">
              <button
                type="submit"
                class="submit-btn"
                [disabled]="isSubmitting || loanForm.invalid"
              >
                {{ isSubmitting ? "Processing..." : "Submit Application" }}
              </button>
            </div>
          </div>

          <div *ngIf="apiError" class="error-message">
            {{ apiError }}
          </div>
        </div>
      </form>
    </div>
  </div>
</div>